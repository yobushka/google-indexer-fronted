<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Google Indexing API – Отправка URL</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/10.5.23/jsrsasign-all-min.js"></script>
</head>
<body>
  <div class="container">
    <section class="section">
      <h2 class="title is-4">Google Indexing API – Отправка URL</h2>
      <form id="indexing-form">
        <div class="field">
          <label class="label">Загрузите файл service-account.json:</label>
          <div class="control">
            <input type="file" id="service-account" accept=".json" class="input" required>
          </div>
        </div>
        <div class="field">
          <label class="label">Введите список URL (по одному на строке):</label>
          <div class="control">
            <textarea id="urls" class="textarea"></textarea>
          </div>
        </div>
        <div class="field">
          <div class="control">
            <input type="submit" value="Отправить в Indexing API" class="button is-primary">
          </div>
        </div>
      </form>
      <h3 class="title is-5">Результаты отправки:</h3>
      <pre id="results" class="box"></pre>
      <script>
      $(document).ready(function(){
        $('#indexing-form').on('submit', function(e){
          e.preventDefault();
          $('#results').text('Обработка...');
          var file = $('#service-account')[0].files[0];
          if(!file) {
            $('#results').text('Пожалуйста, загрузите service-account.json');
            return;
          }
          
          var reader = new FileReader();
          reader.onload = function(evt){
            var creds;
            try {
              creds = JSON.parse(evt.target.result);
            } catch(err){
              $('#results').text('Ошибка чтения учетных данных.');
              return;
            }
            var urls = $('#urls').val().split("\n").map(function(u){ return $.trim(u); }).filter(function(u){ return u; });
            if(urls.length === 0){
              $('#results').text('Пожалуйста, введите хотя бы один URL.');
              return;
            }
            var now = Math.floor(Date.now()/1000);
            var header = { alg: "RS256", typ: "JWT" };
            var claim = {
              iss: creds.client_email,
              scope: "https://www.googleapis.com/auth/indexing",
              aud: "https://oauth2.googleapis.com/token",
              iat: now,
              exp: now + 3600
            };
            var sHeader = JSON.stringify(header);
            var sClaim = JSON.stringify(claim);
            var jwt;
            try {
              jwt = KJUR.jws.JWS.sign("RS256", sHeader, sClaim, creds.private_key);
            } catch(e) {
              $('#results').text('Ошибка генерации JWT: ' + e);
              return;
            }
            
            // Получаем access token
            $.ajax({
              url: 'https://oauth2.googleapis.com/token',
              method: 'POST',
              data: {
                grant_type: "urn:ietf:params:oauth:grant-type:jwt-bearer",
                assertion: jwt
              },
              success: function(tokenData){
                if(!tokenData.access_token){
                  $('#results').text('Ошибка: не удалось получить access token.');
                  return;
                }
                var token = tokenData.access_token;
                var resultsText = "";
                var requests = [];
                $.each(urls, function(index, url){
                  var payload = JSON.stringify({
                    url: url,
                    type: "URL_UPDATED"
                  });
                  requests.push(
                    $.ajax({
                      url: 'https://indexing.googleapis.com/v3/urlNotifications:publish',
                      method: 'POST',
                      contentType: 'application/json',
                      headers: { "Authorization": "Bearer " + token },
                      data: payload
                    }).then(function(response){
                      resultsText += url + " → " + (response.notifyTime || "Успешно") + "\n";
                    }, function(jqXHR){
                      var errMsg = "Ошибка";
                      try {
                        var resp = JSON.parse(jqXHR.responseText);
                        if(resp && resp.error && resp.error.message){
                          errMsg = resp.error.message;
                        }
                      } catch(e) {}
                      resultsText += url + " → " + errMsg + "\n";
                    })
                  );
                });
                $.when.apply($, requests).always(function(){
                  $('#results').text(resultsText);
                });
              },
              error: function(jqXHR){
                var errMsg = "Ошибка при запросе access token";
                try {
                  var resp = JSON.parse(jqXHR.responseText);
                  if(resp && resp.error && resp.error.message) {
                    errMsg = resp.error.message;
                  }
                } catch(e) {}
                $('#results').text(errMsg);
              }
            });
          };
          reader.readAsText(file);
        });
      });
      </script>
    </section>
  </div>
</body>
</html>