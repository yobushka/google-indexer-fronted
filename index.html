<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Google Indexing API – URL Submission</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
  <!-- Optionally add Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <!-- Added Bulma Tooltip CSS for tooltip instructions -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma-tooltip/dist/css/bulma-tooltip.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/10.5.23/jsrsasign-all-min.js"></script>
</head>
<body>
  <div class="container">
    <section class="section">
      <div class="has-text-centered">
        <svg width="200" height="200" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
          <!-- Background circle -->
          <circle cx="100" cy="100" r="95" fill="#f5f5f5" stroke="#3273dc" stroke-width="5"/>
          <!-- Letter G -->
          <text x="40" y="130" font-size="80" font-family="sans-serif" fill="#3273dc">G</text>
          <!-- Letter I -->
          <text x="100" y="130" font-size="80" font-family="sans-serif" fill="#23d160">I</text>
        </svg>
      </div>
      <h2 class="title is-4">Google Indexing API – URL Submission</h2>
      <form id="indexing-form">
        <div class="field">
          <label class="label">
            Upload the service-account.json file:
            <span class="icon has-tooltip-multiline" data-tooltip="Instructions: Obtain service-account.json from the Google Cloud Console. Go to the Credentials section, select or create a Service Account, and download the JSON file.">
              <i class="fas fa-info-circle"></i>
            </span>
          </label>
          <div class="control">
            <input type="file" id="service-account" accept=".json" class="input" required>
            <span id="file-status"></span> <!-- File status -->
          </div>
        </div>
        <div class="field">
          <label class="label">Enter a list of URLs (one per line):</label>
          <div class="control">
            <textarea id="urls" class="textarea"></textarea>
          </div>
        </div>
        <div class="field">
          <div class="control">
            <input type="submit" value="Submit to Indexing API" class="button is-primary">
          </div>
        </div>
      </form>
      <h3 class="title is-5">Submission Results:</h3>
      <pre id="results" class="box" style="display: none;"></pre>
      <script>
      $(document).ready(function(){
        // Validate service-account file on selection
        $("#service-account").on('change', function() {
          var file = this.files[0];
          $("#file-status").empty();
          if(!file) return;
          var reader = new FileReader();
          reader.onload = function(evt) {
            try {
              var creds = JSON.parse(evt.target.result);
              if(creds.client_email && creds.private_key) {
                $("#file-status").html('<span class="tag is-success">Valid file</span>');
              } else {
                $("#file-status").html('<span class="tag is-danger">Invalid file</span>');
              }
            } catch(e) {
              $("#file-status").html('<span class="tag is-danger">Invalid file</span>');
            }
          };
          reader.readAsText(file);
        });
        $('#indexing-form').on('submit', function(e){
          e.preventDefault();
          $("#results").show();
          $('#results').text('Processing...');
          var file = $('#service-account')[0].files[0];
          if(!file) {
            $('#results').text('Please upload service-account.json');
            return;
          }
          
          var reader = new FileReader();
          reader.onload = function(evt){
            var creds;
            try {
              creds = JSON.parse(evt.target.result);
            } catch(err){
              $('#results').text('Error reading credentials.');
              return;
            }
            // Validate required keys in the service-account file
            if(!creds.client_email || !creds.private_key) {
              $('#results').text('Invalid format for service-account.json. The file must contain client_email and private_key.');
              return;
            }
            var urls = $('#urls').val().split("\n").map(function(u){ return $.trim(u); }).filter(function(u){ return u; });
            if(urls.length === 0){
              $('#results').text('Please enter at least one URL.');
              return;
            }
            var now = Math.floor(Date.now()/1000);
            var header = { alg: "RS256", typ: "JWT" };
            var claim = {
              iss: creds.client_email,
              scope: "https://www.googleapis.com/auth/indexing",
              aud: "https://oauth2.googleapis.com/token",
              iat: now,
              exp: now + 3600
            };
            var sHeader = JSON.stringify(header);
            var sClaim = JSON.stringify(claim);
            var jwt;
            try {
              jwt = KJUR.jws.JWS.sign("RS256", sHeader, sClaim, creds.private_key);
            } catch(e) {
              $('#results').text('JWT generation error: ' + e);
              return;
            }
            
            // Fetch access token
            $.ajax({
              url: 'https://oauth2.googleapis.com/token',
              method: 'POST',
              data: {
                grant_type: "urn:ietf:params:oauth:grant-type:jwt-bearer",
                assertion: jwt
              },
              success: function(tokenData){
                if(!tokenData.access_token){
                  $('#results').text('Error: unable to obtain access token.');
                  return;
                }
                var token = tokenData.access_token;
                var resultsText = "";
                var requests = [];
                $.each(urls, function(index, url){
                  var payload = JSON.stringify({
                    url: url,
                    type: "URL_UPDATED"
                  });
                  requests.push(
                    $.ajax({
                      url: 'https://indexing.googleapis.com/v3/urlNotifications:publish',
                      method: 'POST',
                      contentType: 'application/json',
                      headers: { "Authorization": "Bearer " + token },
                      data: payload
                    }).then(function(response){
                      resultsText += url + " → " + (response.notifyTime || "Success") + "\n";
                    }, function(jqXHR){
                      var errMsg = "Error";
                      try {
                        var resp = JSON.parse(jqXHR.responseText);
                        if(resp && resp.error && resp.error.message){
                          errMsg = resp.error.message;
                        }
                      } catch(e) {}
                      resultsText += url + " → " + errMsg + "\n";
                    })
                  );
                });
                $.when.apply($, requests).always(function(){
                  $('#results').text(resultsText);
                });
              },
              error: function(jqXHR){
                var errMsg = "Error fetching access token";
                try {
                  var resp = JSON.parse(jqXHR.responseText);
                  if(resp && resp.error && resp.error.message) {
                    errMsg = resp.error.message;
                  }
                } catch(e) {}
                $('#results').text(errMsg);
              }
            });
          };
          reader.readAsText(file);
        });
      });
      </script>
    </section>
  </div>
</body>
</html>